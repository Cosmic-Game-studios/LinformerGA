<x-app-layout>
    {{-- ─────────── Sidebar ─────────── --}}
    <x-app-marginal class="border-end bg-light">
        <div class="list-group list-group-flush position-sticky top-0" style="max-height: 100vh; overflow-y: auto">
            <div class="list-group-item fw-semibold text-uppercase small bg-body-tertiary">
                <i class="fas fa-list-ul me-1"></i>
                Logs
            </div>

            @forelse($files as $file)
                @php $isActive = $currentFile === $file->getFilename(); @endphp
                <a  href="{{ route('admin.errorlog.index', ['file' => $file->getFilename()]) }}"
                    class="list-group-item list-group-item-action d-flex justify-content-between
                           align-items-center {{ $isActive ? 'active' : '' }}">
                        <span class="text-truncate" style="max-width: 150px">
                            <i class="fas fa-file-alt me-2 opacity-75"></i>{{ $file->getFilename() }}
                        </span>
                        <small class="opacity-75">{{ number_format($file->getSize()/1024,1) }} KB</small>
                </a>
            @empty
                <div class="list-group-item text-center text-muted small">
                    Keine Log-Dateien
                </div>
            @endforelse
        </div>
    </x-app-marginal>

    {{-- ─────────── Hauptinhalt ─────────── --}}
    <x-app-content>
        <div class="card shadow-sm">
            {{-- Header --}}
            <div class="card-header d-flex flex-wrap gap-2 justify-content-between align-items-center bg-body-tertiary">
                <span class="fw-semibold text-truncate">
                    <i class="fas fa-bug me-2"></i>{{ $currentFile }}
                </span>

                <div class="btn-toolbar gap-2">
                    {{-- Download --}}
                    <a  href="{{ route('admin.errorlog.download', ['file' => $currentFile]) }}"
                        class="btn btn-sm btn-outline-secondary"
                        data-bs-toggle="tooltip" data-bs-title="Download">
                        <i class="fas fa-download"></i>
                    </a>

                    {{-- Clear --}}
                    <form  action="{{ route('admin.errorlog.clear') }}" method="POST"
                           onsubmit="return confirm('Alle älteren Log-Dateien löschen?');">
                        @csrf @method('DELETE')
                        <button class="btn btn-sm btn-outline-danger"
                                data-bs-toggle="tooltip" data-bs-title="Alte Logs löschen">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </form>
                </div>
            </div>

            {{-- Tabelle mit Log-Zeilen --}}
            <div class="table-responsive" style="max-height: 70vh; overflow-y: auto">
                <table class="table table-sm table-hover mb-0 align-middle text-wrap">
                    <tbody>
                    @foreach($logs as $entry)
                        @php
                            $badge = match($entry['level']) {
                                'error'     => 'bg-danger',
                                'critical'  => 'bg-danger',
                                'warning'   => 'bg-warning text-dark',
                                default     => 'bg-info text-dark'
                            };
                        @endphp
                        <tr>
                            <td style="width: 110px">
                                <span class="badge {{ $badge }}">{{ strtoupper($entry['level']) }}</span>
                            </td>
                            <td class="font-monospace small">{{ $entry['raw'] }}</td>
                        </tr>
                    @endforeach
                    </tbody>
                </table>
            </div>

            {{-- Pagination --}}
            <div class="card-footer bg-white d-flex justify-content-center">
                {{ $logs->withQueryString()->links() }}
            </div>
        </div>
    </x-app-content>
</x-app-layout>

@push('scripts')
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Bootstrap-Tooltips aktivieren
    [...document.querySelectorAll('[data-bs-toggle="tooltip"]')].forEach(el => new bootstrap.Tooltip(el));

    // automatisch zur ersten ERROR-Zeile scrollen
    const firstErrorRow = document.querySelector('tr td .badge.bg-danger')?.closest('tr');
    if (firstErrorRow) firstErrorRow.scrollIntoView({behavior:'smooth', block:'center'});
});
</script>
@endpush